-- 코드를 입력하세요
SELECT 
SUBSTR(SALES_DATE,1,4) AS YEAR
,TO_NUMBER(SUBSTR(SALES_DATE,5,6)) AS MONTH
,SUM(B.ONE) AS PUCHASED_USERS
,ROUND(SUM(B.ONE)/A.ONE,1) AS PUCHASED_RATIO
FROM 
(SELECT 
 USER_ID
,COUNT(*) OVER() AS ONE 
FROM USER_INFO 
WHERE TO_CHAR(JOINED,'YYYY') = '2021'
) A
, 
(SELECT DISTINCT
 USER_ID
 , TO_CHAR(SALES_DATE,'YYYYMM') AS SALES_DATE
 , 1 AS ONE 
 FROM ONLINE_SALE
 GROUP BY USER_ID, TO_CHAR(SALES_DATE,'YYYYMM')
 ) B
 WHERE A.USER_ID = B.USER_ID
GROUP BY SUBSTR(SALES_DATE,1,4),TO_NUMBER(SUBSTR(SALES_DATE,5,6)), A.ONE
ORDER BY YEAR, MONTH;
